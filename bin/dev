#!/usr/bin/env bash

# Ensure the development vault variable is defined.
if [ -z "$OBSIDIAN_DEVELOPMENT_VAULT" ]; then
  echo "The OBSIDIAN_DEVELOPMENT_VAULT variable must be defined."
  exit 1
fi

# Generate the paths
OBSIDIAN_DEVELOPMENT_VAULT=$(realpath "$OBSIDIAN_DEVELOPMENT_VAULT")
ROOT_DIRECTORY=$(dirname "$(dirname "$(realpath "$0")")")
SOURCE_DIRECTORY="$ROOT_DIRECTORY/plugins"
DEVELOPMENT_PLUGINS_DIRECTORY="$OBSIDIAN_DEVELOPMENT_VAULT/.obsidian/plugins"

for PLUGIN_SOURCE_DIRECTORY in "$SOURCE_DIRECTORY"/*; do
  # Generate the plugin paths
  BASENAME=$(basename "$PLUGIN_SOURCE_DIRECTORY")
  PLUGIN_DEVELOPMENT_DIRECTORY="$DEVELOPMENT_PLUGINS_DIRECTORY/$BASENAME"

  # Create the plugin directory.
  mkdir -p "$PLUGIN_DEVELOPMENT_DIRECTORY"

  # Create a hotreload file so Hot Reload will run on the plugin.
  touch "$PLUGIN_DEVELOPMENT_DIRECTORY"/.hotreload

  # Copy the manifest.
  rm -f "$PLUGIN_DEVELOPMENT_DIRECTORY"/manifest.json
  cp "$PLUGIN_SOURCE_DIRECTORY"/manifest.json "$PLUGIN_DEVELOPMENT_DIRECTORY"/manifest.json
done

# Start the development server.
node esbuild.config.mjs
