#!/usr/bin/env bash

# Ensure the vault variable is defined.
if [ -z "$OBSIDIAN_VAULT" ]; then
  echo "The OBSIDIAN_VAULT variable must be defined."
  exit 1
fi

# Build all of the plugins.
pnpm build

# Generate the paths
VAULT=$(realpath "$OBSIDIAN_VAULT")
ROOT=$(dirname "$(dirname "$(realpath "$0")")")
SOURCE="$ROOT/plugins"
DIST="$ROOT/dist"
VAULT_PLUGINS="$VAULT/.obsidian/plugins"

for PLUGIN_SOURCE in "$SOURCE"/*; do
  # Generate the plugin paths
  PLUGIN_NAME=$(basename "$PLUGIN_SOURCE")
  PLUGIN_DIST="$DIST/$PLUGIN_NAME"
  VAULT_PLUGINS="$VAULT_PLUGINS/$PLUGIN_NAME"

  # Copy the build files
  mkdir -p "$VAULT_PLUGINS"
  cp "$PLUGIN_DIST"/main.js "$VAULT_PLUGINS"/main.js
  cp "$PLUGIN_SOURCE"/manifest.json "$VAULT_PLUGINS"/manifest.json
done
